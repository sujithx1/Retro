<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Evara Dashboard</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta property="og:title" content="" />
    <meta property="og:type" content="" />
    <meta property="og:url" content="" />
    <meta property="og:image" content="" />
    <!-- Favicon -->
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="/assets/imgs/theme/favicon.svg"
    />
    <!-- Template CSS -->
    <link href="/assets/css/main.css" rel="stylesheet" type="text/css" />
    <!-- Include SweetAlert CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />

    <style>
      li {
        list-style-type: none;
      }
      table {
  font-family: Arial, sans-serif;
  border-collapse: collapse;
  width: 100%;
}

td, th {
  border: 1px solid #ddd;
  padding: 8px;
}

th {
  text-align: left;
  background-color: #f2f2f2;
}

    </style>
  </head>

  <body>
    <div class="screen-overlay"></div>
    <aside class="navbar-aside" id="offcanvas_aside">
      <div class="aside-top">
        <a href="#"><img src="/users/assets/imgs/theme/logo1.svg" alt="logo"></a>

        <div>
          <button class="btn btn-icon btn-aside-minimize">
            <i class="text-muted material-icons md-menu_open"></i>
          </button>
        </div>
      </div>
      <nav>
        <ul class="menu-aside">
          <li class="menu-item">
            <a class="menu-link" href="home">
              <i class="icon material-icons md-home"></i>
              <span class="text">Dashboard</span>
            </a>
          </li>
          <li class="menu-item">
            <a class="menu-link" href="product">
              <i class="icon material-icons md-shopping_bag"></i>
              <span class="text">Products</span>
            </a>
            <!-- <div class="submenu">
                        <a href="page-products-list.html">Product List</a>
                        <a href="page-products-grid.html">Product grid</a>
                        <a href="page-products-grid-2.html">Product grid 2</a>
                        <a href="page-categories.html">Categories</a>
                    </div> -->
          </li>
          <li class="menu-item">
            <a class="menu-link" href="orderlist">
              <i class="icon material-icons md-shopping_cart"></i>
              <span class="text">Orders</span>
            </a>
            <!-- <div class="submenu">
                        <a href="page-orders-1.html" class="active">Order list 1</a>
                        <a href="page-orders-2.html">Order list 2</a>
                        <a href="page-orders-detail.html">Order detail</a>
                        <a href="page-orders-tracking.html">Order tracking</a>
<a href="page-invoice.html">Invoice</a>
                    </div> -->
          </li>
          <li class="menu-item">
            <a class="menu-link" href="users">
              <i class="icon material-icons md-store"></i>
              <span class="text">Users</span>
            </a>
            <!-- <div class="submenu">
                        <a href="page-sellers-cards.html">Sellers cards</a>
                        <a href="page-sellers-list.html">Sellers list</a>
                        <a href="page-seller-detail.html">Seller profile</a>
                    </div> -->
          </li>
          <li class="menu-item">
            <a class="menu-link" href="addproduct">
              <i class="icon material-icons md-add_box"></i>
              <span class="text">Add product</span>
            </a>
            <!-- <div class="submenu">
                        <a href="page-form-product-1.html">Add product 1</a>
                        <a href="page-form-product-2.html">Add product 2</a>
                        <a href="page-form-product-3.html">Add product 3</a>
                        <a href="page-form-product-4.html">Add product 4</a>
                    </div> -->
          </li>
          <li class="menu-item">
            <a class="menu-link" href="category">
              <i class="icon material-icons md-store"></i>
              <span class="text">Categories</span>
            </a>
            <!-- <li class="menu-item has-submenu">
                    <a class="menu-link" href="page-transactions-1.html"> <i class="icon material-icons md-monetization_on"></i>
                        <span class="text">Transactions</span>
                    </a> -->
            <!-- <div class="submenu">
                        <a href="page-transactions-1.html">Transaction 1</a>
                        <a href="page-transactions-2.html">Transaction 2</a>
                        <a href="page-transactions-details.html">Transaction Details</a>
                    </div> -->
          </li>
          <li class="menu-item">
            <a class="menu-link" href="/admin/coupons">
              <i class="icon material-icons md-stars"></i>
              <span class="text">Coupons</span>
            </a>
          </li>
          <!-- <li class="menu-item ">
            <a class="menu-link" href="#">
              <i class="icon material-icons md-person"></i>
              <span class="text">Account</span>
            </a> -->
            <!-- <div class="submenu">
              <a href="page-account-login.html">User login</a>
              <a href="page-account-register.html">User registration</a>
              <a href="page-error-404.html">Error 404</a>
            </div>-->
          <!-- </li>  -->
          <li class="menu-item active" >
            <a class="menu-link" href="/admin/offer" >
              <i class="icon material-icons md-comment"></i>
              <span class="text">Offer</span>
            </a>
          </li>
          
        
       
        <li class="menu-item">
            <a class="menu-link" disabled href="/admin/statistics"> <i class="icon material-icons md-pie_chart"></i>
                <span class="text">Statistics</span>
            </a>
        </li>
        </ul>
        <hr />
        <!-- <ul class="menu-aside">
          <li class="menu-item has-submenu">
            <a class="menu-link" href="#">
              <i class="icon material-icons md-settings"></i>
              <span class="text">Settings</span>
            </a>
            <div class="submenu">
              <a href="page-settings-1.html">Setting sample 1</a>
              <a href="page-settings-2.html">Setting sample 2</a>
            </div>
          </li>
          <li class="menu-item">
            <a class="menu-link" href="page-blank.html">
              <i class="icon material-icons md-local_offer"></i>
              <span class="text"> Starter page </span>
            </a>
          </li>
        </ul> -->
        <br />
        <br />
      </nav>
    </aside>

<main class="main-wrap">

    <div "></div>


    <section class="content-main">
        <div class="content-header">
            <div>
                <h2 class="content-title card-title">Offer</h2>
                <p>Add, edit or delete a offer</p>
            </div>
            <div>
                <a  class="btn btn-primary btn-sm rounded" href="/admin/offer/product/add" >Product</a>
                <a  class="btn btn-primary btn-sm rounded" href="/admin/offer/category/add" >Category</a>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>Product Name</th>
                                    <th>Offer</th>
                                    <th>Description</th>
                                    <th>type</th>
                                    <th>Offer Percentage</th>
                                    <th>Update</th>
                                    <th>Action</th>
                                </tr>
                                </thead>
                                <tbody>
                                  <%if (offer){%>
                                    <% offer.forEach(ofr=>{%>
                                <tr >
                                  
                                   
                                    <td>
                                      <% if (ofr.isActive){%>
                                      
                                        <span  class="badge badge-pill badge-soft-success" >Active</span>
                                        <%} else {%>
                                        <span class="badge badge-pill badge-soft-danger" >Blocked </span>
                                      
                                    </td>
                                    <%}%>

                                    
                                     
                                    <td>
                                      <% if (ofr.product){%>
                                    <%= ofr.product.name %>
                                    <%}else{%>
                                      <%= ofr.category.name %>
                                      <%}%>
                                    </td>
                                    <td ><%= ofr.offerName  %></td>
                                    <td ><%= ofr.offerDescription %></td>
                                     <td>
                                      <input type="text"  style="width: 100px;" class="form-control"  value="<%= ofr.offertype %>" readonly></td>
                                    <td ><%= ofr.Discount %></td>
                                    <td>
                                        <a href="/admin/offer/edit?offerId=<%= ofr._id %>" class="btn btn-success" >Edit</a>
                                    </td>
                                    <!-- <td>
                                      <%if(ofr.isActive){%>
                                        <button type="button" id="removebtn" class="btn btn-danger btn-sm" >Remove Offer </button>
                                        <input type="hidden" value="<%= ofr._id %>" name="" id="removeId">
                                        <input type="hidden" value="<%= ofr.offertype %>" id="removetype">
                                        <% if(ofr.product) {%>
                                        <input type="hidden" value="<%= ofr.product._id %>" name="" id="removepro">
                                        <%} else {%>
                                          <input type="hidden" value="<%= ofr.Discount %>" name="" id="removedis">
                                          <input type="hidden" value="<%= ofr.category._id %>" name="" id="removecat">
                                          <%} %>

                                        <%}else{%>
                                        <button type="button" id="applybtn"  class="btn btn-primary btn-sm "  > Apply Offer </button>
                                        <input type="hidden" value="<%= ofr._id %>" name="" id="applyId">
                                        <input type="hidden" value="<%= ofr.offertype %>" id="applytype">

                                        <% if(ofr.product) {%>
                                        <input type="hidden" value="<%= ofr.product._id %>" name="" id="applypro">
                                        <%} else {%>
                                          <input type="hidden" value="<%= ofr.Discount %>" name="" id="applydis">

                                          <input type="hidden" value="<%= ofr.category._id %>" name="" id="applycat">
                                          <%}%>

                                        <%}%>
                                       
                                    </td> -->
                                    <td>
                                      <% if(ofr.isActive) { %>
                                          <button type="button" id="removebtn_<%= ofr._id %>" class="btn btn-danger btn-sm">Remove Offer</button>
                                          <input type="hidden" value="<%= ofr._id %>" id="removeId_<%= ofr._id %>">
                                          <input type="hidden" value="<%= ofr.offertype %>" id="removetype_<%= ofr._id %>">
                                          <% if(ofr.product) { %>
                                              <input type="hidden" value="<%= ofr.product._id %>" id="removepro_<%= ofr._id %>">
                                          <% } else { %>
                                              <input type="hidden" value="<%= ofr.Discount %>" id="removedis_<%= ofr._id %>">
                                              <input type="hidden" value="<%= ofr.category._id %>" id="removecat_<%= ofr._id %>">
                                          <% } %>
                                      <% } else { %>
                                          <button type="button" id="applybtn_<%= ofr._id %>" class="btn btn-primary btn-sm">Apply Offer</button>
                                          <input type="hidden" value="<%= ofr._id %>" id="applyId_<%= ofr._id %>">
                                          <input type="hidden" value="<%= ofr.offertype %>" id="applytype_<%= ofr._id %>">
                                          <% if(ofr.product) { %>
                                              <input type="hidden" value="<%= ofr.product._id %>" id="applypro_<%= ofr._id %>">
                                          <% } else { %>
                                              <input type="hidden" value="<%= ofr.Discount %>" id="applydis_<%= ofr._id %>">
                                              <input type="hidden" value="<%= ofr.category._id %>" id="applycat_<%= ofr._id %>">
                                          <% } %>
                                      <% } %>
                                  </td>
                                  
                                    <%})%>
                                </tr>
                                <%}%>
                                </tbody>
                            </table>
                        </div>
                    </div> <!-- .col// -->
                </div> <!-- .row // -->
            </div> <!-- card body .// -->
        </div> <!-- card .// -->  
        <!-- Add category-->
    </section> <!-- content-main end// -->
    
</main>
<!-- Include SweetAlert JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
<script>

//   document.addEventListener('DOMContentLoaded',function(){

  
    
//     const removebtn=document.getElementById('removebtn')
//     const applybtn=document.getElementById('applybtn')
//     //  const applybtn = document.getElementById(`applybtn_${offerId}`);
//     // const removebtn = document.getElementById(`removebtn_${offerId}`);


//     const statusDiv = document.querySelector('.badge');


    
    
//     // console.log("offertype ",offertype);
    

//     function applayOffer(){
//       const removebtn=document.getElementById('removebtn')
//     const applybtn=document.getElementById('applybtn')
//       const offerId= document.getElementById('applyId').value

//       const offertype=document.getElementById('applytype').value
//     console.log("offertype ",offertype);
      
      
    
//     if (applybtn) {
//         applybtn.addEventListener('click', applayOffer);
//         console.log("applay button clicked ");
//     }

//     if (removebtn) {
//         removebtn.addEventListener('click', removeOffer);
//         console.log("remove butttotn clicked");
//     }


//       let data;
//       if(offertype=="Product Offer")

//       {
//         const productId=document.getElementById('applypro').value
//         data={offerId:offerId,
//             productId:productId,
//             offertype:offertype

//         }
//       }else{

//         const discount=document.getElementById('applydis').value
//       const categoryId=document.getElementById('applycat').value
//       data={
//         offerId:offerId,
//         categoryId:categoryId,
//         offertype:offertype,
//         discount:discount

//       }
//       }

//       console.log("data ",data);
//       console.log("offerId",offerId);
//       fetch('/admin/offer/applay', {
//     method: 'POST',
//     headers: {
//         "Content-Type": "application/json",
//     },
//     body: JSON.stringify({ data })
// })
// .then(response => response.json())
// .then(data => {
//     console.log("response", data);
//     if (data.success) {
//         console.log("completed");

//         // Update the status and toggle buttons
//         statusDiv.className = 'badge badge-pill badge-soft-success';
//         statusDiv.textContent = 'Active';

//         Swal.fire({
//             icon: "success",
//             title: "Success!",
//             text: "Offer applied successfully",
//             confirmButtonText: "OK",
//         }).then(() => {
//             // Optionally, you can redirect the user after the alert
//             window.location.href = "/admin/offer";
//         });
//     } else {
//         Swal.fire({
//             icon: "error",
//             title: "Error!",
//             text: "Failed to apply the offer. Please try again.",
//             confirmButtonText: "OK",
//         });
//     }
// })
// .catch(error => {
//     console.error("Error:", error);
//     Swal.fire({
//         icon: "error",
//         title: "Error!",
//         text: "An unexpected error occurred. Please try again.",
//         confirmButtonText: "OK",
//     });
// });

    
//     }

//     function removeOffer()
//     {
//       const removebtn=document.getElementById('removebtn')
//     const applybtn=document.getElementById('applybtn')
//       const offerId= document.getElementById('removeId').value

//       // 


//       const offertype=document.getElementById('removetype').value
//     console.log("offertype ",offertype);
      
      
//       let data;
//       if(offertype=="Product Offer")

//       {
//         const productId=document.getElementById('removepro').value
//         data={offerId:offerId,
//             productId:productId,
//             offertype:offertype

//         }
//       }else{

//         const discount=document.getElementById('removedis').value
//       const categoryId=document.getElementById('removecat').value
//       data={
//         offerId:offerId,
//         categoryId:categoryId,
//         offertype:offertype,
//         discount:discount

//       }
//       }
//       console.log("offerId",offerId);
//       fetch('/admin/offer/remove', {
//     method: 'POST',
//     headers: {
//         "Content-Type": "application/json",
//     },
//     body: JSON.stringify({ data })
// })
// .then(response => response.json())
// .then(data => {
//     console.log("response", data);
//     if (data.success) {
//         console.log("completed");

//         // Update the status and toggle buttons
//         statusDiv.className = 'badge badge-pill badge-soft-danger';
//         statusDiv.textContent = 'Blocked';

//         // Optionally, redirect or update UI after the alert
//         Swal.fire({
//             icon: "success",
//             title: "Success!",
//             text: "Offer removed successfully",
//             confirmButtonText: "OK",
//         }).then(() => {
//             window.location.href = "/admin/offer";
//         });

//     } else {
//         Swal.fire({
//             icon: "error",
//             title: "Error!",
//             text: "Failed to remove the offer. Please try again.",
//             confirmButtonText: "OK",
//         });
//     }
// })
// .catch(error => {
//     console.error("Error:", error);
//     Swal.fire({
//         icon: "error",
//         title: "Error!",
//         text: "An unexpected error occurred. Please try again.",
//         confirmButtonText: "OK",
//     });
// });


//     }




//   })
document.addEventListener('DOMContentLoaded', function() {
    // Event delegation for dynamically created buttons
    document.body.addEventListener('click', function(event) {
        if (event.target.matches('.btn-primary.btn-sm')) {
            applyOffer(event.target.id.split('_')[1]);
        } else if (event.target.matches('.btn-danger.btn-sm')) {
            removeOffer(event.target.id.split('_')[1]);
        }
    });

    function applyOffer(offerId) {
        const statusDiv = document.querySelector(`.badge`);
        const applybtn = document.getElementById(`applybtn_${offerId}`);
        const removebtn = document.getElementById(`removebtn_${offerId}`);

        const offertype = document.getElementById(`applytype_${offerId}`).value;
        let data;

        if (offertype === "Product Offer") {
            const productId = document.getElementById(`applypro_${offerId}`).value;
            data = {
                offerId: offerId,
                productId: productId,
                offertype: offertype
            };
        } else {
            const discount = document.getElementById(`applydis_${offerId}`).value;
            const categoryId = document.getElementById(`applycat_${offerId}`).value;
            data = {
                offerId: offerId,
                categoryId: categoryId,
                offertype: offertype,
                discount: discount
            };
        }

        fetch('/admin/offer/apply', {
            method: 'POST',
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
              statusDiv.className = 'badge badge-pill badge-soft-success';
                statusDiv.textContent = 'Active';

                if (applybtn) applybtn.style.display = 'none';
                if (removebtn) removebtn.style.display = 'inline-block';

                Swal.fire({
                    icon: "success",
                    title: "Success!",
                    text: "Offer applied successfully",
                    confirmButtonText: "OK",
                }).then(() => {
                    window.location.href = "/admin/offer";
                });
            } else {
                Swal.fire({
                    icon: "error",
                    title: "Error!",
                    text: "Failed to apply the offer. Please try again.",
                    confirmButtonText: "OK",
                });
            }
        })
        .catch(error => {
            console.error("Error:", error);
            Swal.fire({
                icon: "error",
                title: "Error!",
                text: "An unexpected error occurred. Please try again.",
                confirmButtonText: "OK",
            });
        });
    }

    function removeOffer(offerId) {
    const offertype = document.getElementById(`removetype_${offerId}`).value;
    let data;

    if (offertype === "Product Offer") {
        const productId = document.getElementById(`removepro_${offerId}`).value;
        data = {
            offerId: offerId,
            productId: productId,
            offertype: offertype
        };
    } else {
        const discount = document.getElementById(`removedis_${offerId}`).value;
        const categoryId = document.getElementById(`removecat_${offerId}`).value;
        data = {
            offerId: offerId,
            categoryId: categoryId,
            offertype: offertype,
            discount: discount
        };
    }

    console.log("Sending data: ", data);  // Add this line to log data

    fetch('/admin/offer/remove', {
        method: 'POST',
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const statusDiv = document.querySelector(`.badge`);
            statusDiv.className = 'badge badge-pill badge-soft-danger';
            statusDiv.textContent = 'Blocked';

            Swal.fire({
                icon: "success",
                title: "Success!",
                text: "Offer removed successfully",
                confirmButtonText: "OK",
            }).then(() => {
                window.location.href = "/admin/offer";
            });
        } else {
            Swal.fire({
                icon: "error",
                title: "Error!",
                text: "Failed to remove the offer. Please try again.",
                confirmButtonText: "OK",
            });
        }
    })
    .catch(error => {
        console.error("Error:", error);
        Swal.fire({
            icon: "error",
            title: "Error!",
            text: "An unexpected error occurred. Please try again.",
            confirmButtonText: "OK",
        });
    });
}

});

</script>
<script src="/assets/js/vendors/jquery-3.6.0.min.js"></script>
<script src="/assets/js/vendors/bootstrap.bundle.min.js"></script>
<script src="/assets/js/vendors/select2.min.js"></script>
<script src="/assets/js/vendors/perfect-scrollbar.js"></script>
<script src="/assets/js/vendors/jquery.fullscreen.min.js"></script>
<!-- Main Script -->
<script src="/assets/js/main.js" type="text/javascript"></script>
</body>

</html>